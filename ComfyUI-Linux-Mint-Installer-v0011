#!/usr/bin/env python3
# ComfyUI Linux Mint Installer — версия с полной диагностикой и пропуском

import os
import sys
import re
import subprocess
import time
import webbrowser
import psutil
from pathlib import Path
from PyQt6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout, QPushButton,
    QTextEdit, QLabel, QProgressBar, QMessageBox, QComboBox
)
from PyQt6.QtCore import Qt, QProcess, QTimer, QProcessEnvironment
from PyQt6.QtGui import QFont, QScreen


# ====================== Пути ======================
BASE_DIR = Path.home() / "ComfyUI-Desktop"
COMFYUI_DIR = BASE_DIR / "ComfyUI"
VENV_DIR = BASE_DIR / "venv"
LOG_DIR = BASE_DIR / "logs"
LOG_FILE = LOG_DIR / "install.log"
DESKTOP_FILE = Path.home() / ".local/share/applications/comfyui.desktop"

for d in (BASE_DIR, LOG_DIR):
    d.mkdir(parents=True, exist_ok=True)

BACKEND_SCRIPT = BASE_DIR / "backend_install.sh"


# ====================== Определение VRAM ======================
def detect_vram():
    try:
        out = subprocess.check_output(
            ["nvidia-smi", "--query-gpu=memory.total", "--format=csv,noheader,nounits"],
            stderr=subprocess.DEVNULL, timeout=4
        ).decode().strip()
        vram_mb = int(float(out))
        if vram_mb >= 24000:
            return "very-high-vram"
        elif vram_mb >= 12000:
            return "high-vram"
        elif vram_mb >= 8000:
            return "normal-vram"
        elif vram_mb >= 4000:
            return "low-vram"
        else:
            return "cpu"
    except:
        return "cpu"


# ====================== Диагностика пакетов ======================
def diagnose_packages(log_widget):
    log_widget.append("=== Диагностика пакетов ===\n")

    required = ['git', 'python3', 'python3-venv', 'python3-pip']
    missing = []
    for pkg in required:
        if subprocess.call(["dpkg", "-s", pkg], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL) != 0:
            missing.append(pkg)

    if missing:
        log_widget.append(f"Недостающие пакеты: {', '.join(missing)}\n")
        reply = QMessageBox.question(
            log_widget.window(),
            "Недостающие пакеты",
            f"Установить {', '.join(missing)} автоматически?\n(Запустится терминал для ввода пароля sudo)",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        if reply == QMessageBox.StandardButton.Yes:
            cmd = f"gnome-terminal -- sudo apt update && sudo apt install -y {' '.join(missing)}"
            subprocess.Popen(cmd, shell=True)
            log_widget.append("Установка пакетов запущена в терминале. Введите пароль sudo при запросе.\nПосле установки перезапустите установщик.\n")
            return False  # Пропуск установки ComfyUI
        else:
            log_widget.append("Установка пакетов пропущена. Продолжение на свой страх и риск.\n")
            return True  # Продолжить несмотря на пропуск
    else:
        log_widget.append("Все пакеты установлены ✓\n")
        return True


# ====================== Диагностика драйверов ======================
def diagnose_drivers(log_widget):
    log_widget.append("\n=== Диагностика драйверов ===\n")
    if subprocess.call(["which", "nvidia-smi"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL) != 0:
        log_widget.append("NVIDIA драйверы не найдены!\n")
        reply = QMessageBox.question(
            log_widget.window(),
            "NVIDIA драйверы",
            "Установить драйверы автоматически?\n(Запустится терминал для ввода пароля sudo)",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        if reply == QMessageBox.StandardButton.Yes:
            cmd = f"gnome-terminal -- sudo ubuntu-drivers autoinstall"
            subprocess.Popen(cmd, shell=True)
            log_widget.append("Установка драйверов запущена в терминале. Введите пароль sudo.\nПосле установки перезагрузите систему и запустите установщик заново.\n")
            return False  # Пропуск
        else:
            log_widget.append("Установка драйверов пропущена. Будет использован CPU-режим.\n")
            return True  # Продолжить
    else:
        log_widget.append("NVIDIA драйверы обнаружены ✓\n")
        return True


# ====================== Backend-скрипт ======================
def create_backend_script(vram_option):
    content = f"""#!/usr/bin/env bash
set -euo pipefail

BASE_DIR="${{HOME}}/ComfyUI-Desktop"
COMFYUI_DIR="${{BASE_DIR}}/ComfyUI"
VENV_DIR="${{BASE_DIR}}/venv"
LOG_FILE="${{BASE_DIR}}/logs/install.log"

mkdir -p "$(dirname "$LOG_FILE")"
echo "[$(date '+%Y-%m-%d %H:%M:%S')] Начало установки" | tee -a "$LOG_FILE"

VRAM_PROFILE="{vram_option}"
echo "[INFO] VRAM profile: $VRAM_PROFILE" | tee -a "$LOG_FILE"

echo "[PHASE] 1/4 : Репозиторий ComfyUI" | tee -a "$LOG_FILE"
if [ -d "$COMFYUI_DIR/.git" ]; then
    cd "$COMFYUI_DIR"
    git pull --progress 2>&1 | tee -a "$LOG_FILE"
else
    git clone --progress https://github.com/comfyanonymous/ComfyUI.git "$COMFYUI_DIR" 2>&1 | tee -a "$LOG_FILE"
fi

echo "[PHASE] 2/4 : Виртуальное окружение" | tee -a "$LOG_FILE"
python3 -m venv "$VENV_DIR" 2>&1 | tee -a "$LOG_FILE"
source "$VENV_DIR/bin/activate"
pip install --upgrade pip setuptools wheel -q 2>&1 | tee -a "$LOG_FILE"

echo "[PHASE] 3/4 : PyTorch + CUDA" | tee -a "$LOG_FILE"
if [[ "$VRAM_PROFILE" != "cpu" ]]; then
    pip install torch torchvision torchaudio \
        --index-url https://download.pytorch.org/whl/cu121 \
        --timeout 180 --retries 12 2>&1 | tee -a "$LOG_FILE" || true
fi

if ! python -c "import torch; print(torch.cuda.is_available())" 2>/dev/null | grep -q True; then
    echo "[WARN] CUDA не установилась → CPU версия" | tee -a "$LOG_FILE"
    pip install torch torchvision torchaudio 2>&1 | tee -a "$LOG_FILE"
fi

echo "[PHASE] 4/4 : Зависимости ComfyUI" | tee -a "$LOG_FILE"
cd "$COMFYUI_DIR"
pip install -r requirements.txt --timeout 120 --retries 8 2>&1 | tee -a "$LOG_FILE"

pip install psutil 2>&1 | tee -a "$LOG_FILE"  # Для мониторинга

echo "[SUCCESS] Установка завершена" | tee -a "$LOG_FILE"
"""

    BACKEND_SCRIPT.write_text(content, encoding="utf-8")
    BACKEND_SCRIPT.chmod(0o755)


# Регулярки
PHASE_RE = re.compile(r'\[PHASE\]\s*(\d+)/4')
SPEED_RE = re.compile(r'(\d+\.?\d*)\s*([KMGi]?[Bb]/[sS])')


class ComfyUILinuxMintInstaller(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("ComfyUI Linux Mint Installer")
        self.resize(760, 540)
        self.center_window()

        self.vram_profile = detect_vram()
        self.proc = QProcess(self)
        self.proc.setProcessChannelMode(QProcess.ProcessChannelMode.MergedChannels)
        self.proc.readyReadStandardOutput.connect(self.handle_output)
        self.proc.finished.connect(self.on_finished)

        self.current_phase = "Диагностика системы..."
        self.total_progress = 0
        self.net_speed = 0.0
        self.net_unit = "B/s"

        self._init_ui()
        self.start_diagnostics()

        # Таймеры для индикаторов
        self.cpu_timer = QTimer(self)
        self.cpu_timer.timeout.connect(self.update_cpu_usage)
        self.net_timer = QTimer(self)
        self.net_timer.timeout.connect(self.update_net_speed)

    def center_window(self):
        qr = self.frameGeometry()
        cp = QScreen.availableGeometry(QApplication.primaryScreen()).center()
        qr.moveCenter(cp)
        self.move(qr.topLeft())

    def start_diagnostics(self):
        self.log.append("→ Запуск диагностики...\n")

        # Диагностика пакетов
        if not diagnose_packages(self.log):
            return

        # Диагностика драйверов
        if not diagnose_drivers(self.log):
            return

        self.phase_label.setText("Готов к установке")
        self.btn_start.setEnabled(True)

    def _init_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)

        # Заголовок
        title = QLabel("ComfyUI Linux Mint Installer")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        title.setFont(QFont("Segoe UI", 18, QFont.Weight.Bold))
        layout.addWidget(title)

        # VRAM выбор
        vram_h = QHBoxLayout()
        vram_h.addWidget(QLabel("Профиль видеокарты:"))
        self.vram_combo = QComboBox()
        self.vram_combo.addItems([
            f"Auto detect ({self.vram_profile})",
            "low-vram (4–8 ГБ)",
            "normal-vram (8–12 ГБ)",
            "high-vram (12–24 ГБ)",
            "very-high-vram (24+ ГБ)",
            "cpu (без видеокарты)"
        ])
        vram_h.addWidget(self.vram_combo)
        vram_h.addStretch()
        layout.addLayout(vram_h)

        self.phase_label = QLabel("Фаза: Диагностика системы...")
        layout.addWidget(self.phase_label)

        self.log = QTextEdit()
        self.log.setReadOnly(True)
        self.log.setFont(QFont("Consolas", 10))
        layout.addWidget(self.log, 1)

        self.pb_total = QProgressBar()
        self.pb_total.setFormat("Общий прогресс: %p%")
        layout.addWidget(self.pb_total)

        self.pb_cpu = QProgressBar()
        self.pb_cpu.setFormat("Загрузка CPU: %p%")
        self.pb_cpu.setStyleSheet("QProgressBar::chunk { background-color: #ff8800; }")
        layout.addWidget(self.pb_cpu)

        speed_h = QHBoxLayout()
        speed_h.addWidget(QLabel("Скорость сети:"))
        self.speed_label = QLabel("0.0 B/s")
        self.speed_label.setStyleSheet("font-weight: bold; color: #00ff88;")
        speed_h.addWidget(self.speed_label)
        speed_h.addStretch()
        layout.addLayout(speed_h)

        btn_h = QHBoxLayout()
        self.btn_start = QPushButton("Установить / Обновить")
        self.btn_cancel = QPushButton("Прервать")
        self.btn_open = QPushButton("Открыть ComfyUI")

        for b in (self.btn_start, self.btn_cancel, self.btn_open):
            b.setMinimumHeight(48)

        self.btn_cancel.setEnabled(False)
        self.btn_open.setEnabled(False)
        self.btn_start.setEnabled(False)  # Отключена до диагностики

        btn_h.addWidget(self.btn_start)
        btn_h.addWidget(self.btn_cancel)
        btn_h.addWidget(self.btn_open)
        layout.addLayout(btn_h)

        self.btn_start.clicked.connect(self.start_installation)
        self.btn_cancel.clicked.connect(self.cancel)
        self.btn_open.clicked.connect(self.launch_comfyui)

    def start_installation(self):
        if self.proc.state() != QProcess.ProcessState.NotRunning:
            return

        selected = self.vram_combo.currentText()
        if "Auto" in selected:
            vram_option = self.vram_profile
        elif "low" in selected:
            vram_option = "low-vram"
        elif "normal" in selected:
            vram_option = "normal-vram"
        elif "high" in selected:
            vram_option = "high-vram"
        elif "very-high" in selected:
            vram_option = "very-high-vram"
        else:
            vram_option = "cpu"

        create_backend_script(vram_option)

        self.pb_total.setValue(0)
        self.pb_cpu.setValue(0)
        self.speed_label.setText("0.0 B/s")
        self.phase_label.setText("Запуск...")

        self.btn_start.setEnabled(False)
        self.btn_cancel.setEnabled(True)
        self.btn_open.setEnabled(False)

        self.proc.start("bash", [str(BACKEND_SCRIPT)])

        self.log.append(">>> Установка запущена...\n")

        self.cpu_timer.start(1000)
        self.net_timer.start(1000)

    def update_cpu_usage(self):
        cpu_percent = psutil.cpu_percent(interval=0.5)
        self.pb_cpu.setValue(int(cpu_percent))

    def update_net_speed(self):
        try:
            io1 = psutil.net_io_counters()
            time.sleep(1)
            io2 = psutil.net_io_counters()
            speed = (io2.bytes_recv - io1.bytes_recv) / 1024
            unit = "KB/s" if speed < 1024 else "MB/s"
            speed = speed if unit == "KB/s" else speed / 1024
            self.speed_label.setText(f"{speed:.1f} {unit}")
        except Exception as e:
            self.speed_label.setText("0.0 B/s")
            self.log.append(f"[WARN] Ошибка сетевого мониторинга: {e}")

    def handle_output(self):
        data = self.proc.readAllStandardOutput().data().decode("utf-8", errors="replace")
        for line in data.splitlines():
            line = line.strip()
            if not line:
                continue

            self.log.append(line)

            # Фазы для общего прогресса
            if m := PHASE_RE.search(line):
                phase_num = int(m.group(1))
                self.pb_total.setValue(phase_num * 25)
                self.phase_label.setText(line.split("]", 1)[1].strip())

        self.log.verticalScrollBar().setValue(self.log.verticalScrollBar().maximum())

    def on_finished(self, exit_code, _):
        self.cpu_timer.stop()
        self.net_timer.stop()
        self.btn_start.setEnabled(True)
        self.btn_cancel.setEnabled(False)

        if exit_code == 0:
            self.pb_total.setValue(100)
            self.phase_label.setText("Установка завершена")
            self.log.append("\n=== УСПЕХ ===\n")
            self.log.append("Создан ярлык в меню Графика (ComfyUI)")

            self.create_desktop_entry()
            self.btn_open.setEnabled(True)

            QMessageBox.information(
                self, "Готово",
                "Установка завершена!\n\n"
                "• Ярлык добавлен в меню Графика\n"
                "• При запуске откроется терминал с прогрессом и браузер"
            )
        else:
            self.phase_label.setText("Ошибка установки")
            self.log.append(f"\n=== Ошибка (код {exit_code}) ===\n")

    def launch_comfyui(self):
        # Запуск через терминал + автоматическое открытие браузера в новой вкладке
        cmd = f"gnome-terminal -- bash -c 'source {VENV_DIR}/bin/activate; cd {COMFYUI_DIR}; python main.py --listen 127.0.0.1 --port 8188 & xdg-open http://127.0.0.1:8188; wait'"
        subprocess.Popen(cmd, shell=True)

    def cancel(self):
        if self.proc.state() != QProcess.ProcessState.NotRunning:
            self.proc.kill()
            self.log.append("\n[Прервано пользователем]\n")
            self.phase_label.setText("Прервано")
            self.btn_start.setEnabled(True)
            self.btn_cancel.setEnabled(False)

    def create_desktop_entry(self):
        desktop_content = f"""[Desktop Entry]
Name=ComfyUI
Exec=gnome-terminal -- bash -c 'source {VENV_DIR}/bin/activate; cd {COMFYUI_DIR}; python main.py --listen 127.0.0.1 --port 8188 & xdg-open http://127.0.0.1:8188; wait'
Icon=applications-graphics
Type=Application
Categories=Graphics;
Terminal=false
StartupNotify=true
"""

        try:
            DESKTOP_FILE.write_text(desktop_content)
            subprocess.run(["update-desktop-database", str(DESKTOP_FILE.parent)], check=False)
        except Exception as e:
            self.log.append(f"[WARN] Не удалось создать ярлык: {e}")


if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setStyle("Fusion")
    window = ComfyUILinuxMintInstaller()
    window.show()
    sys.exit(app.exec())
